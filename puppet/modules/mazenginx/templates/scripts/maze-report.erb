#
# maze nginx report script - mazenginx/templates/scripts/maze-report.erb
#
#
# this file was generated by puppet
# do not overwrite this file, or puppet will overwrite it again...
# so only customize this file in puppet itself
#
###############################################################################

escapeJSON() {
    RAW=$1
    RAW=${RAW//\\/\\\\} # \.
    RAW=${RAW//\//\\\/} # /.
    RAW=${RAW//\"/\\\"} # ".
    RAW=`echo "$RAW" | sed 's/\t/    /g'`
    RAW=${RAW//    /\\t} # \t (tab)
    RAW=${RAW//
/\\\n} # \n (newline)
    RAW=${RAW//^M/\\\r} # \r (carriage return)
    RAW=${RAW//^L/\\\f} # \f (form feed)
    RAW=${RAW//^H/\\\b} # \b (backspace)
    echo "$RAW"
}  

checkNginxConfig()
{
    if [ ! -d "$NGINX_DIR" -o ! -d "$NGINX_DIR_AVAILABLE" -o ! -d "$NGINX_DIR_ENABLED" ]; then
        echo "Invalid nginx config dir"
        exit 101
    fi

    if [ ! -w "$NGINX_DIR_AVAILABLE" -o ! -w "$NGINX_DIR_ENABLED" ]; then
        echo "Invalid nginx config dir not writable"
        exit 102
    fi    
}

getRawVhostContent()
{
    VHOST="$1"

    VHOST_CONTENT_RAW=`maze nginx vhost -N ${VHOST}`
    if [ "$?" != 0 ]; then
        exit 111
    fi

    echo "${VHOST_CONTENT_RAW}"
}

getEscapedVhostContent()
{
    VHOST="$1"

    VHOST_CONTENT_RAW=`getRawVhostContent ${VHOST}`
    if [ "$?" != 0 ]; then
        exit 111
    fi

    escapeJSON "${VHOST_CONTENT_RAW}"
}

getVhostDomain()
{
    VHOST="$1"

    VHOST_CONTENT_RAW=`getRawVhostContent ${VHOST}`
    if [ "$?" != 0 ];then
        exit 111
    fi

    VHOST_DOMAIN=`echo "$VHOST_CONTENT_RAW" | sed 's/#.*$//' | grep server_name | awk '{ sub(/;/, "", $2); print $2}'`
    escapeJSON "${VHOST_DOMAIN}"
}

getVhostStatus()
{
    VHOST="$1"

    VHOST_FILE_ENABLED="${NGINX_DIR_ENABLED}/${VHOST}"
    if [ -f "$VHOST_FILE_ENABLED" ]; then
        echo "true"
    else
        echo "false"
    fi
}

report()
{
    VHOSTS=`maze nginx vhost`
    if [ "$?" != 0 ]; then
        echo "couldn't get vhosts list"
        exit 103
    fi
    
    VHOSTS=`echo "$VHOSTS" | grep -v ^$ | uniq`
    if [ -z "$VHOSTS" ]; then
        echo "{}"
        exit 0
    fi

    NGINX_POST="{"

    for VHOST in $VHOSTS
    do
        VHOST_CONTENT=`getEscapedVhostContent ${VHOST}`
        if [ "$?" != 0 ]; then
            continue
        fi

        VHOST_MD5=`echo -n "$VHOST" | md5sum | awk '{print $1}'`
        VHOST_STATUS=`getVhostStatus "${VHOST}"`
        VHOST_LABEL=`escapeJSON "${VHOST}"`
        VHOST_DOMAIN=`getVhostDomain "${VHOST}"`
        
        NGINX_POST="${NGINX_POST}
    \"${VHOST_MD5}\":{
        \"label\":\"${VHOST_LABEL}\",
        \"content\":\"${VHOST_CONTENT}\",
        \"domain\":\"${VHOST_DOMAIN}\",
        \"status\":\"${VHOST_STATUS}\"
    }"

    if [ "`echo "$VHOSTS" | tail -n 1`" != "$VHOST" ]; then
        NGINX_POST="${NGINX_POST},"
    fi
    done

    NGINX_POST="${NGINX_POST}
}"

    echo "${NGINX_POST}"
    exit 0
}


checkNginxConfig

report
