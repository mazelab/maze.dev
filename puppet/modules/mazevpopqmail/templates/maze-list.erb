#!/bin/bash
#
# maze vpopqmail domain script - mazevpopqmail/templates/maze-list.erb
#
#
# this file was generated by puppet
# do not overwrite this file, or puppet will overwrite it again...
# so only customize this file in puppet itself
#
###############################################################################

MESSAGE_USAGE='maze vpopqmail list [$mailingList|add|del|sub] [$mailingList|add|del] [$mailingList] [$subscriber(s[add])|.(del)]'

EZMLM_PATH='/usr/local/bin/ezmlm/'
EZMLM_LIST="${EZMLM_PATH}ezmlm-list"
EZMLM_MAKE="${EZMLM_PATH}ezmlm-make"
EZMLM_SUB="${EZMLM_PATH}ezmlm-sub"
EZMLM_UNSUB="${EZMLM_PATH}ezmlm-unsub"

QFILE_PREFIX='.qmail-'

addMailingList() {
    EMAIL=$(echo "$1" | tr '[:upper:]' '[:lower:]')

    if isMailingList $EMAIL ; then
        echo "Given email is allready a mailing list!"
        exit 306
    fi

    $EZMLM_MAKE $MAILDIR $QFILE_BASE $USER $DOMAIN
    if [ `echo "$?"` != 0 ]; then
        echo "error occured while adding mailing list $EMAIL"
        exit 307
    fi

    # ensure vpopmail file permissions
    chown -R $VPOPMAIL_USER:$VPOPMAIL_GROUP  $MAILDIR

    exit 0
}

addSubscriber() {
    EMAIL=$(echo "$1" | tr '[:upper:]' '[:lower:]')
    SUBSCRIBER=$(echo "$2" | tr '[:upper:]' '[:lower:]')

    if ! isMailingList $EMAIL ; then
        echo "Given email is no mailing list!"
        exit 301
    fi
    # parse multiple subs
    for i in $SUBSCRIBER; do
        if ! isEmail $i ; then
            echo "Given subscriber email $i is invalid!"
            exit 304
        fi
    done

    if ! isEmail $SUBSCRIBER ; then
        echo 'Given subscriber email $SUBSCRIBER is invalid!'
        exit 304
    fi

    $EZMLM_SUB $MAILDIR $SUBSCRIBER
    if [ `echo "$?"` != 0 ]; then
        echo "error occured while adding subscriber $SUBSCRIBER to $EMAIL"
        exit 303
    fi

    exit 0
}

delMailingList() {
    EMAIL=$(echo "$1" | tr '[:upper:]' '[:lower:]')

    if ! isMailingList $EMAIL ; then
        if [ -d $MAILDIR ]; then
            echo "Given email is no mailing list but seems to be a mail account! You should check that..."
            exit 310
        elif [ -f $QFILE_BASE ]; then
            echo "Given email is no mailing list but seems to be a forwarder! You should check that..."
            exit 311
        fi

        exit 0
    fi

    if [ ! -w $MAILDIR ]; then
        echo "No permissons do delete list folder $MAILDIR"
        exit 308
    fi
    if [ ! -w $QFILE_BASE -o ! -w $QFILE_DEFAULT -o ! -w $QFILE_OWNER -o ! -w $QFILE_RETURN_DEFAULT ]; then
        echo "No permissions to delete one or multiple $QFILE_BASE * files"
        exit 309
    fi

    rm -r $QFILE_BASE $QFILE_DEFAULT $QFILE_OWNER $QFILE_RETURN_DEFAULT $MAILDIR
    if [ `echo "$?"` != 0 ]; then
        echo "Error occured while deleting list $EMAIL. Manuell fixing might be necessary"
        exit 310
    fi

    exit 0
}

delSubscriber() {
    EMAIL=$(echo "$1" | tr '[:upper:]' '[:lower:]')
    SUBSCRIBER=$(echo "$2" | tr '[:upper:]' '[:lower:]')

    if ! isMailingList $EMAIL ; then
        echo "Given email is no mailing list!"
        exit 301
    fi
    if ! isEmail $SUBSCRIBER ; then
        echo 'Given subscriber email is invalid!'
        exit 304
    fi

    $EZMLM_UNSUB $MAILDIR $SUBSCRIBER
    if [ `echo "$?"` != 0 ]; then
        echo "error occured while removing subscriber $SUBSCRIBER to $EMAIL"
        exit 305
    fi

    exit 0
}

delSubscribers() {
    EMAIL=$(echo "$1" | tr '[:upper:]' '[:lower:]')
    
    if ! isMailingList $EMAIL ; then
        echo "Given email is no mailing list!"
        exit 301
    fi

    SUBSCRIBERS_DIR="$MAILDIR/subscribers"
    SUBS_EMPTY=`find $SUBSCRIBERS_DIR -type d -empty`

    if [ $SUBS_EMPTY ]; then
        exit 0
    fi
    if [ ! -w "$SUBSCRIBERS_DIR" ]; then
        echo "No permission do remove subscribers"
        exit 310
    fi

    rm $SUBSCRIBERS_DIR/*
    if [ `echo "$?"` != 0 ]; then
        echo "error occured while removing subscribers from mailing list $EMAIL"
        exit 311
    fi
    
    exit 0
}

isEmail() {
    _EMAIL=$(echo "$1" | tr '[:upper:]' '[:lower:]')

    if ! [[ "$_EMAIL" =~ [A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,4} ]]; then
        return 1
    fi

    return 0
}

isMailingList() {
    _EMAIL=$(echo "$1" | tr '[:upper:]' '[:lower:]')

    if ! isEmail $_EMAIL ; then
        echo 'Given email is invalid!'
        exit 301
    fi

    USER=$(echo "$_EMAIL" | cut -d'@' -f1)
    DOMAIN=$(echo "$_EMAIL" | cut -d'@' -f2)
    DIR=`$VPOPMAIL_BIN/vdominfo -d $DOMAIN`
    if [ `echo "$?"` != 0 ]; then
        exit 302
    fi

    MAILDIR="$DIR/$USER"
    QFILE_BASE="$DIR/$QFILE_PREFIX$USER"
    QFILE_DEFAULT="$QFILE_BASE-default"
    QFILE_OWNER="$QFILE_BASE-owner"
    QFILE_RETURN_DEFAULT="$QFILE_BASE-return-default"

    if [ ! -d $MAILDIR ]; then
        return 1
    fi
    if [ ! -f $QFILE_BASE ]; then
        return 1
    fi
    if [ ! -f $QFILE_DEFAULT ]; then
        return 1
    fi
    if [ ! -f $QFILE_OWNER ]; then
        return 1
    fi
    if [ ! -f $QFILE_RETURN_DEFAULT ]; then
        return 1
    fi

    return 0
}

getSubscribers() {
    EMAIL=$(echo "$1" | tr '[:upper:]' '[:lower:]')

    if ! isMailingList $EMAIL ;then
        echo "Given email is no mailing list!"
        exit 301
    fi

    $EZMLM_LIST $MAILDIR
    if [ `echo "$?"` != 0 ]; then
        echo "error occured while getting subscribers list"
        exit 303
    fi

    exit 0
}

case $1 in
  'add')
        if [ -n "$2" -a -z "$3" ]; then
            addMailingList "$2"
        fi
    ;;
  'del')
        if [ -n "$2" -a -z "$3" ]; then
            delMailingList "$2"
        fi
    ;;
    'sub')
        case $2 in
            'add')
                if [ -n "$3" -a -n "$4" -a -z "$5" ]; then
                    addSubscriber "$3" "$4"
                fi
             ;;
            'del')
                case "$4" in
                    '.')
                        if [ -n "$3" -a -n "$4" -a -z "$5" ]; then
                            delSubscribers "$3"
                        fi
                    ;;
                    *)
                        if [ -n "$3" -a -n "$4" -a -z "$5" ]; then
                            delSubscriber "$3" "$4"
                        fi
                    ;;
                esac
             ;;
            *)
                if [ -n "$2" -a -z "$3" ]; then
                    getSubscribers "$2"
                fi
             ;;
        esac
    ;;
  *)
        if [ -n "$1" -a -z "$2" ]; then
            getSubscribers "$1"
        fi
    ;;
esac

echo $MESSAGE_USAGE
exit 201