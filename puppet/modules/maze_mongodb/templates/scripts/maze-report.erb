##
# maze script to manage mongodb report
#
###############################################################################

report()
{
    CMD="var report={};db.runCommand({listDatabases:1}).databases.forEach(function(doc){if(doc.empty===true){return false}var database=db.getSiblingDB(doc.name),stats=database.stats(),dbReport={};dbReport.name=doc.name;dbReport.users=database.system.users.find({},{user:1,pwd:1,_id:0}).toArray();dbReport.stats={'dataSize':stats.dataSize,'indexSize':stats.indexSize,'storageSize':stats.storageSize,'fileSize':stats.fileSize};report[doc.name] = dbReport});printjson(report)";
    if ! REPORT=`mongodbCmd "$CMD" "admin"`; then
        echo "failed to generate report"
        return 100
    fi

    echo "$REPORT"
}

report
exit "$?"