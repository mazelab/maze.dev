#!/bin/bash
#
# maze vpopqmail domain script - mazevpopqmail/templates/maze-robot.erb
#
#
# this file was generated by puppet
# do not overwrite this file, or puppet will overwrite it again...
# so only customize this file in puppet itself
#
###############################################################################

MESSAGE_USAGE='maze vpopqmail robot [$email|add|del] [$email] [$responsetext] [$copytoemail]'

AUTORESPONDER_BIN="/usr/bin/autorespond"
QFILE_PREFIX='.qmail-'

ROBOT_MESSAGE_FILE='message'
ROBOT_LOG_FOLDER_NAME='autorespond'

DEFAULT_TIME='1000'
DEFAULT_RESPONSES_IN_TIME='5'

isEmail() {

    if ! [[ "$1" =~ [A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,4} ]]; then
        return 291
    fi

    return 0
}

addRobot() {
    EMAIL=$(echo "$1" | tr '[:upper:]' '[:lower:]')
    RESPONSE_TEXT="$2"
    COPY_TO=$(echo "$3" | tr '[:upper:]' '[:lower:]')

    if ! isEmail $EMAIL ; then
        echo 'invalid email'
        exit 291
    fi
    if [ -n "$COPY_TO" ]; then
        if ! isEmail $COPY_TO ; then
            echo 'invalid email to copy to'
            exit 292
        fi
    fi    

    USER=$(echo "$EMAIL" | cut -d'@' -f1)
    DOMAIN=$(echo "$EMAIL" | cut -d'@' -f2)
    DIR=`$VPOPMAIL_BIN/vdominfo -d $DOMAIN`

    if [ `echo "$?"` != 0 ]; then
        echo "error occured while getting domain dir"
        exit 293
    fi

    QFILE_PATH="$DIR/$QFILE_PREFIX$USER"
    if [ ! -f $QFILE_PATH -a ! -w $DIR ]; then
        echo "domain folder $DIR not writable"
        exit 294
    fi
    if [ -f $QFILE_PATH -a ! -w $QFILE_PATH ]; then
        echo "file $QFILE_PATH not writable"
        exit 295
    fi

    # create user folder if not existent
    USER_FOLDER_PATH="$DIR/$USER"
    if [ ! -d $USER_FOLDER_PATH -o ! -w $DIR ]; then
        if [ ! -w $DIR ]; then
            echo "domain folder $DIR not writable"
            exit 294
        else
            mkdir $USER_FOLDER_PATH
            chown $VPOPMAIL_USER:$VPOPMAIL_GROUP $USER_FOLDER_PATH
        fi
    fi

    # write message file in user folder
    ROBOT_MESSAGE_FILE="$USER_FOLDER_PATH/$ROBOT_MESSAGE_FILE"
    if [ ! -w $ROBOT_MESSAGE_FILE -a ! -w $USER_FOLDER_PATH ]; then
        echo "can't write in message file $ROBOT_MESSAGE_FILE"
        exit 297
    fi

    echo "$RESPONSE_TEXT" > $ROBOT_MESSAGE_FILE
    if [ `echo "$?"` != 0 ]; then
        echo "something went wrong while writing $ROBOT_MESSAGE_FILE file"
        exit 298
    fi

    # create folder for autorespond logs
    ROBOT_LOG_FOLDER="$USER_FOLDER_PATH/$ROBOT_LOG_FOLDER_NAME"
    if [ ! -d $ROBOT_LOG_FOLDER ]; then
        if [ ! -w $USER_FOLDER_PATH ]; then
            echo "can't create log folder $ROBOT_LOG_FOLDER"
            exit 299    
        else
            mkdir $ROBOT_LOG_FOLDER
            chown $VPOPMAIL_USER:$VPOPMAIL_GROUP $ROBOT_LOG_FOLDER
        fi
    fi

    # write .qmail-* user file
    echo "|$AUTORESPONDER_BIN $DEFAULT_TIME $DEFAULT_RESPONSES_IN_TIME $MESSAGE_PATH $ROBOT_MESSAGE_FILE $ROBOT_LOG_FOLDER" > $QFILE_PATH
    if [ `echo "$?"` != 0 ]; then
        echo "something went wrong while writing $QFILE_PATH file"
        exit 296
    fi

    if [ "$COPY_TO" ]; then
        echo "&$COPY_TO" >> $QFILE_PATH
        if [ `echo "$?"` != 0 ]; then
            echo "something went wrong while writing $QFILE_PATH file"
            exit 296
        fi
    fi

    exit 0
}

delRobot() {
    EMAIL=$(echo "$1" | tr '[:upper:]' '[:lower:]')

    if ! isEmail $EMAIL ; then
        echo 'invalid email'
        exit 291
    fi

    USER=$(echo "$EMAIL" | cut -d'@' -f1)
    DOMAIN=$(echo "$EMAIL" | cut -d'@' -f2)
    DIR=`$VPOPMAIL_BIN/vdominfo -d $DOMAIN`
    if [ `echo "$?"` != 0 ]; then
        echo "error occured while getting domain dir"
        exit 293
    fi

    QFILE_PATH="$DIR/$QFILE_PREFIX$USER"
    if [ -f $QFILE_PATH -a ! -w $QFILE_PATH ]; then
        echo "file $QFILE_PATH not writable"
        exit 295
    fi

    if [ -f $QFILE_PATH ]; then
        rm $QFILE_PATH
        if [ `echo "$?"` != 0 ]; then
            echo "something went wrong while deleting $QFILE_PATH file"
            exit 297
        fi
    fi

    exit 0
}

getRobot() {
    EMAIL=$(echo "$1" | tr '[:upper:]' '[:lower:]')

    if ! isEmail $EMAIL ; then
        echo 'invalid email'
        exit 291
    fi

    USER=$(echo "$EMAIL" | cut -d'@' -f1)
    DOMAIN=$(echo "$EMAIL" | cut -d'@' -f2)
    DIR=`$VPOPMAIL_BIN/vdominfo -d $DOMAIN`
    if [ `echo "$?"` != 0 ]; then
        echo "error occured while getting domain dir"
        exit 293
    fi

    QFILE_PATH="$DIR/$QFILE_PREFIX$USER"
    if [ ! -f $QFILE_PATH ]; then
        echo ''
        exit 0
    fi

    cat $QFILE_PATH
    exit 0
}

case $1 in
  'add')
        if [ -n "$2" -a -n "$3" ]; then
            addRobot "$2" "$3" "$4"
        fi
    ;;
  'del')
        if [ -n "$2" ]; then
            delRobot "$2"
        fi
    ;;
  *)
        if [ -n "$1" ]; then
            getRobot "$1"
        fi
    ;;
esac

echo $MESSAGE_USAGE
exit 201