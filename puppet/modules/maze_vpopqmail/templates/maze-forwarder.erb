#!/bin/bash
#
# maze vpopqmail forwarder script - mazevpopqmail/templates/maze-forwarder.erb
#
#
# this file was generated by puppet
# do not overwrite this file, or puppet will overwrite it again...
# so only customize this file in puppet itself
#
###############################################################################

MESSAGE_USAGE='maze vpopqmail forwarder [$domain|$email|add|delete] [$email] [$target]'

addForwarder() {
    EMAIL="$1"
    TARGET="$2"

    RESULT=`$VPOPMAIL_BIN/valias -i $TARGET $EMAIL`
    STATUS=`echo "$?"`

    echo "$RESULT"
    exit $STATUS
}

deleteForwarder() {
    EMAIL="$1"

    RESULT=`$VPOPMAIL_BIN/valias -d $EMAIL`
    STATUS=`echo "$?"`

    echo "$RESULT"
    exit $STATUS
}

# index can be email or domain
getForwarder() {
    INDEX="$1"

    INFO=`$VPOPMAIL_BIN/valias $INDEX`
    STATUS=`echo "$?"`

    NONFORWARDERS=`echo "$INFO" | grep  -i '/bin/ezmlm\|/bin/autorespond\|/Mailbox' | awk '{print $1}' | uniq`
    for NONFORWARDER in $NONFORWARDERS
    do
        if [ "$NONFORWARDERS_GREP" ]; then
            NONFORWARDERS_GREP="${NONFORWARDERS_GREP}\|"
        fi

        NONFORWARDERS_GREP="${NONFORWARDERS_GREP}^${NONFORWARDER}"
    done

    if [ "$NONFORWARDERS_GREP" ]; then
        INFO=`echo "$INFO" | grep  -i -v "${NONFORWARDERS_GREP}"`
    fi

    echo "$INFO"
    exit $STATUS
}

case $1 in
  "add")
        if [ -n "$2" -a -n "$3"  ]; then
            addForwarder $2 $3
        fi
    ;;
  "delete")
        if [ -n "$2"  ]; then
            deleteForwarder $2
        fi
    ;;
  *)
        if [ -n "$1" -a -z "$2" ]; then
            getForwarder $1
        fi
    ;;
esac

echo $MESSAGE_USAGE
exit 201