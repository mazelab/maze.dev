#!/bin/bash
#
# maze vpopqmail domain script - mazevpopqmail/templates/maze-robot.erb
#
#
# this file was generated by puppet
# do not overwrite this file, or puppet will overwrite it again...
# so only customize this file in puppet itself
#
###############################################################################

MESSAGE_USAGE='maze vpopqmail catchall [$domain|set] [$email|delete|bounce|bounce-no-mailbox]'

QMAIL_DEFAULT_FILENAME='.qmail-default'
VPOPMAIL_DELIVER_BIN="$VPOPMAIL_BIN/vdelivermail"

DIRECTIVE_DELETE='delete'
DIRECTIVE_BOUNCE='bounce-no-mailbox'
DIRECTIVE_BOUNCE_SHORT='bounce'

# allowed directives: $email|$DIRECTIVE_DELETE|$DIRECTIVE_BOUNCE
setCatchAll() {
    DOMAIN=$(echo "$1" | tr '[:upper:]' '[:lower:]')
    DIRECTIVE=$(echo "$2" | tr '[:upper:]' '[:lower:]')

    if [ $DIRECTIVE != $DIRECTIVE_DELETE -a $DIRECTIVE != $DIRECTIVE_BOUNCE -a $DIRECTIVE != $DIRECTIVE_BOUNCE_SHORT ]; then
        if ! [[ "$DIRECTIVE" =~ [A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,4} ]]; then
            echo "Email address $email is invalid."
            exit 282
        fi
    fi

    DIR=`$VPOPMAIL_BIN/vdominfo -d $DOMAIN`

    if [ `echo "$?"` != 0 ]; then
        echo "error occured while getting domain dir"
        exit 281
    fi

    QMAIL_DEFAULT_FILE="$DIR/$QMAIL_DEFAULT_FILENAME"
    if [ ! -f $QMAIL_DEFAULT_FILE -a ! -w $DIR ]; then
        echo "domain Folder $DIR not writable"
        exit 283
    fi
    if [ -f $QMAIL_DEFAULT_FILE -a ! -w $QMAIL_DEFAULT_FILE ]; then
        echo "file $QMAIL_DEFAULT_FILE not writable"
        exit 284
    fi

    if [ $DIRECTIVE == $DIRECTIVE_BOUNCE_SHORT ]; then
        DIRECTIVE="$DIRECTIVE_BOUNCE"
    fi

    echo "| $VPOPMAIL_DELIVER_BIN '' $DIRECTIVE" > $QMAIL_DEFAULT_FILE

    if [ `echo "$?"` != 0 ]; then
        echo "something went wrong while writing .qmail-default file"
        exit 285
    fi

    exit 0
}

getCatchAll() {
    DOMAIN=$(echo "$1" | tr '[:upper:]' '[:lower:]')
    DIR=`$VPOPMAIL_BIN/vdominfo -d $DOMAIN`

    if [ `echo "$?"` != 0 ]; then
        echo "error occured while getting domain dir"
        exit 281
    fi

    QMAIL_DEFAULT_FILE="$DIR/$QMAIL_DEFAULT_FILENAME"
    if [ -f $QMAIL_DEFAULT_FILE -a ! -r $QMAIL_DEFAULT_FILE ]; then
        echo "file $QMAIL_DEFAULT_FILE not readable"
        exit 286
    fi

    if [ ! -s $QMAIL_DEFAULT_FILE ]; then
        echo "file $QMAIL_DEFAULT_FILE is empty"
        exit 287
    fi    

    cat $QMAIL_DEFAULT_FILE

    exit 0
}

case $1 in
  'set')
        if [ -n "$2" -a -n "$3" ]; then
            setCatchAll $2 $3
        fi
    ;;
  *)
        if [ -n "$1" ]; then
            getCatchAll $1
        fi
    ;;
esac

echo $MESSAGE_USAGE
exit 201